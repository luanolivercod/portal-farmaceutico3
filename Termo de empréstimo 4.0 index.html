<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador e Gestor de Empréstimos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1e3a8a;
            text-align: center;
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
        }
        form {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }
        .form-section {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 6px;
            background-color: #f9f9f9;
        }
        .form-section h2 {
            margin-top: 0;
            color: #3b82f6;
            font-size: 1.2em;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        .input-group label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .input-group input[type="text"],
        .input-group input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        #materials-list {
            width: 100%;
            border-collapse: collapse;
        }
        #materials-list th, #materials-list td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #materials-list th {
            background-color: #e2e8f0;
        }
        #add-material-button {
            margin-top: 10px;
            background-color: #10b981;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #add-material-button:hover {
            background-color: #059669;
        }
        .remove-material-button {
            background-color: #ef4444;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }
        .button-group button {
            padding: 15px;
            border: none;
            border-radius: 4px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #submit-button {
            background-color: #3b82f6;
            color: white;
        }
        #submit-button:hover {
            background-color: #2563eb;
        }
        #report-button {
            background-color: #60a5fa;
            color: white;
        }
        #report-button:hover {
            background-color: #3b82f6;
        }
        .records-section {
            display: none;
        }
        .print-area {
            display: none;
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            background-color: #fcfcfc;
        }
        .print-via {
            border: 2px dashed #999;
            padding: 20px;
            margin-bottom: 20px;
        }
        .print-header h2 {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        .print-header h3 {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 20px;
            border-bottom: 1px solid #000;
            padding-bottom: 5px;
        }
        .print-section p {
            margin: 5px 0;
            line-height: 1.5;
        }
        .print-list {
            list-style: none;
            padding: 0;
            border: 1px solid #000;
            margin-top: 10px;
        }
        .print-list li {
            padding: 5px;
            border-bottom: 1px dashed #ccc;
        }
        .print-list li:last-child {
            border-bottom: none;
        }
        .print-signatures {
            margin-top: 40px;
            text-align: center;
        }
        .print-signatures .signature-line {
            width: 80%;
            margin: 0 auto 5px auto;
            border-bottom: 1px solid #000;
        }
        .print-signatures p {
            margin-bottom: 20px;
        }
        @media print {
            body {
                background-color: #fff;
                padding: 0;
            }
            .container, .modal {
                display: none;
            }
            .print-area {
                display: block;
                border: none;
                padding: 0;
                margin: 0;
                box-shadow: none;
            }
            .print-via {
                page-break-after: always;
                border: none;
            }
        }
        
        /* Modal para o relatório */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .report-table th, .report-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            word-wrap: break-word;
        }
        .report-table th {
            background-color: #e2e8f0;
        }
        .report-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .status-button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }
        .status-emprestado {
            background-color: #ef4444;
        }
        .status-devolvido {
            background-color: #10b981;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Gerador e Gestor de Termos de Empréstimo</h1>
    <form id="loan-form">
        <div class="form-section">
            <h2>Dados do Empréstimo</h2>
            <div class="input-group">
                <label for="responsavel-emprestimo">Responsável pelo Empréstimo:</label>
                <input type="text" id="responsavel-emprestimo" name="responsavel-emprestimo" required>
            </div>
            <div class="input-group">
                <label for="cargo-emprestimo">Cargo/Função:</label>
                <input type="text" id="cargo-emprestimo" name="cargo-emprestimo" required>
            </div>
        </div>

        <div class="form-section">
            <h2>Dados da Instituição Recebedora</h2>
            <div class="input-group">
                <label for="instituicao-recebedora">Instituição:</label>
                <input list="instituicoes" id="instituicao-recebedora" name="instituicao-recebedora" required>
                <datalist id="instituicoes"></datalist>
            </div>
            <div class="input-group">
                <label for="cnpj">CNPJ:</label>
                <input type="text" id="cnpj" name="cnpj" required>
            </div>
            <div class="input-group">
                <label for="endereco">Endereço:</label>
                <input type="text" id="endereco" name="endereco" required>
            </div>
            <div class="input-group">
                <label for="solicitante">Solicitante:</label>
                <input type="text" id="solicitante" name="solicitante" required>
            </div>
            <div class="input-group">
                <label for="cargo-solicitante">Cargo/Função:</label>
                <input type="text" id="cargo-solicitante" name="cargo-solicitante" required>
            </div>
            <div class="input-group">
                <label for="responsavel-recebimento">Responsável pelo Recebimento:</label>
                <input type="text" id="responsavel-recebimento" name="responsavel-recebimento" required>
            </div>
        </div>

        <div class="form-section">
            <h2>Materiais/Itens Emprestados</h2>
            <table id="materials-list">
                <thead>
                    <tr>
                        <th>Material/Item</th>
                        <th>Quantidade</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
            <button type="button" id="add-material-button">Adicionar Material</button>
        </div>

        <div class="form-section">
            <h2>Prazos</h2>
            <div class="input-group">
                <label for="data-transferencia">Data da Transferência:</label>
                <input type="date" id="data-transferencia" name="data-transferencia" required>
            </div>
            <div class="input-group">
                <label for="previsao-devolucao">Previsão de Devolução:</label>
                <input type="date" id="previsao-devolucao" name="previsao-devolucao">
            </div>
            <div class="input-group">
                <label for="data-assinatura">Data da Assinatura:</label>
                <input type="date" id="data-assinatura" name="data-assinatura" required>
            </div>
        </div>

        <div class="button-group">
            <button type="button" id="report-button">Gerar Relatório</button>
            <button type="submit" id="submit-button">Salvar e Gerar Termo</button>
        </div>
    </form>
</div>

<div class="print-area"></div>

<div id="report-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Relatório de Empréstimos</h2>
        <div id="report-container">
            <p>Carregando dados...</p>
        </div>
    </div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzf-KK-VyCHOTgqLW5TITPW9bcOTO7BVm946W0kSrhYzu9fEh7nFwnlbPUObE5hTrbA/exec'; // **IMPORTANTE: COLOQUE A URL AQUI**
    const form = document.getElementById('loan-form');
    const materialsList = document.querySelector('#materials-list tbody');
    const addMaterialBtn = document.getElementById('add-material-button');
    const printArea = document.querySelector('.print-area');
    const reportButton = document.getElementById('report-button');
    const reportModal = document.getElementById('report-modal');
    const closeModalBtn = document.querySelector('.close-button');
    const reportContainer = document.getElementById('report-container');
    
    // Elementos da nova funcionalidade de busca de instituições
    const instituicaoInput = document.getElementById('instituicao-recebedora');
    const instituicaoDatalist = document.getElementById('instituicoes');
    let instituicoesData = []; // Armazenará os dados das instituições

    // Função para carregar e exibir as instituições no datalist
    const loadInstituicoes = async () => {
        try {
            const response = await fetch(`${scriptURL}?action=getInstituicoes`);
            instituicoesData = await response.json();
            if (instituicoesData.status === 'success') {
                instituicaoDatalist.innerHTML = '';
                instituicoesData.data.forEach(inst => {
                    const option = document.createElement('option');
                    option.value = inst.Instituicao;
                    instituicaoDatalist.appendChild(option);
                });
            }
        } catch (error) {
            console.error("Erro ao carregar instituições:", error);
        }
    };
    
    // Preenche os campos do formulário ao selecionar uma instituição na lista
    instituicaoInput.addEventListener('input', () => {
        const selectedValue = instituicaoInput.value;
        const instituicao = instituicoesData.data.find(inst => inst.Instituicao === selectedValue);
        if (instituicao) {
            document.getElementById('cnpj').value = instituicao.CNPJ;
            document.getElementById('endereco').value = instituicao.Endereco;
            document.getElementById('solicitante').value = instituicao.Solicitante;
            document.getElementById('cargo-solicitante').value = instituicao.Cargo_Solicitante;
            document.getElementById('responsavel-recebimento').value = instituicao.Responsavel_Recebimento;
        } else {
            // Limpa os campos se o valor não for uma instituição válida
            document.getElementById('cnpj').value = '';
            document.getElementById('endereco').value = '';
            document.getElementById('solicitante').value = '';
            document.getElementById('cargo-solicitante').value = '';
            document.getElementById('responsavel-recebimento').value = '';
        }
    });

    // Chamada inicial para carregar as instituições
    loadInstituicoes();

    const addMaterialRow = () => {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="text" name="material" style="width: 100%; box-sizing: border-box;" required></td>
            <td><input type="text" name="quantidade" style="width: 100%; box-sizing: border-box;" required></td>
            <td><button type="button" class="remove-material-button">Remover</button></td>
        `;
        materialsList.appendChild(newRow);
    };

    addMaterialRow();
    addMaterialBtn.addEventListener('click', addMaterialRow);
    materialsList.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-material-button')) {
            e.target.closest('tr').remove();
        }
    });

    const getFormData = () => {
        const data = {};
        const inputs = form.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            if (input.name) {
                data[input.name] = input.value;
            }
        });
        const materials = [];
        document.querySelectorAll('#materials-list tbody tr').forEach(row => {
            const materialInput = row.querySelector('input[name="material"]');
            const quantidadeInput = row.querySelector('input[name="quantidade"]');
            if (materialInput.value.trim() && quantidadeInput.value.trim()) {
                materials.push({ material: materialInput.value.trim(), quantidade: quantidadeInput.value.trim() });
            }
        });
        data.materials = JSON.stringify(materials);
        return data;
    };
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const materials = getFormData().materials;
        if (materials === "[]") {
            alert("Por favor, adicione pelo menos um material.");
            return;
        }
        if (!form.checkValidity()) {
            alert("Por favor, preencha todos os campos obrigatórios.");
            return;
        }
        const formData = getFormData();
        try {
            await fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(formData)
            });
            alert('Dados salvos na planilha com sucesso!');
            generateLoanTerm(formData);
            form.reset();
            materialsList.innerHTML = '';
            addMaterialRow();
        } catch (error) {
            console.error('Erro ao enviar dados para o Google Apps Script:', error);
            alert('Ocorreu um erro ao salvar os dados. Verifique o console para mais detalhes.');
        }
    });

    const formatDate = (dateString) => {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('pt-BR');
    };

    const formatMaterialsList = (materialsJSON) => {
        const materials = JSON.parse(materialsJSON);
        if (materials.length === 0) return '';
        let listHTML = '<ul class="print-list">';
        materials.forEach(item => {
            listHTML += `<li>${item.material}: ${item.quantidade}</li>`;
        });
        listHTML += '</ul>';
        return listHTML;
    };

    const generateLoanTerm = (data) => {
        printArea.innerHTML = '';
        const documentContent = `
            <div class="print-header">
                <h2>TERMO DE TRANSFERÊNCIA POR EMPRÉSTIMO DE MATERIAIS</h2>
                <h3>INSTITUTO DE DESENVOLVIMENTO, ENSINO E ASSISTÊNCIA À SAÚDE – IDEAS</h3>
            </div>
            <div class="print-section">
                <p><strong>Responsável pelo Empréstimo:</strong> ${data['responsavel-emprestimo']} &nbsp;&nbsp;&nbsp;&nbsp; <strong>Cargo/Função:</strong> ${data['cargo-emprestimo']}</p>
            </div>
            <div class="print-section">
                <h4>DADOS DA INSTITUIÇÃO RECEBEDORA</h4>
                <p><strong>Instituição:</strong> ${data['instituicao-recebedora']} &nbsp;&nbsp;&nbsp;&nbsp; <strong>CNPJ:</strong> ${data.cnpj} &nbsp;&nbsp;&nbsp;&nbsp; <strong>Endereço:</strong> ${data.endereco}</p>
                <p><strong>Solicitante:</strong> ${data.solicitante} &nbsp;&nbsp;&nbsp;&nbsp; <strong>Cargo/Função:</strong> ${data['cargo-solicitante']}</p>
                <p><strong>Responsável pelo Recebimento:</strong> ${data['responsavel-recebimento']}</p>
            </div>
            <div class="print-section">
                <h4>DESCRIÇÃO DOS MATERIAIS/ITENS EMPRESTADOS</h4>
                ${formatMaterialsList(data.materials)}
            </div>
            <div class="print-section">
                <h4>PRAZO DO EMPRÉSTIMO</h4>
                <p><strong>Data da Transferência:</strong> ${formatDate(data['data-transferencia'])}</p>
                <p><strong>Previsão de Devolução:</strong> ${formatDate(data['previsao-devolucao']) || 'Não definido'}</p>
            </div>
            <div class="print-section">
                <h4>TERMO DE RESPONSABILIDADE</h4>
                <p style="text-align: justify;">A instituição recebedora declara estar ciente de que os materiais emprestados são de propriedade do IDEAS e se compromete a devolvê-los nas mesmas condições em que foram recebidos, no prazo estipulado. Em caso de perda, extravio ou danos, será responsável pela reposição ou ressarcimento conforme avaliação do IDEAS.</p>
            </div>
            <div class="print-signatures">
                <h4>ASSINATURAS</h4>
                <p><strong>Responsável pelo IDEAS:</strong> ${data['responsavel-emprestimo']}</p>
                <div class="signature-line"></div>
                <p><strong>Responsável pelo Recebimento:</strong> ${data['responsavel-recebimento']}</p>
                <div class="signature-line"></div>
                <p><strong>Data:</strong> ${formatDate(data['data-assinatura'])}</p>
            </div>
        `;
        const via1 = document.createElement('div');
        via1.classList.add('print-via');
        via1.innerHTML = `<h3>VIA 1: IDEAS</h3>${documentContent}`;
        printArea.appendChild(via1);

        const via2 = document.createElement('div');
        via2.classList.add('print-via');
        via2.innerHTML = `<h3>VIA 2: ${data['instituicao-recebedora'].toUpperCase()}</h3>${documentContent}`;
        printArea.appendChild(via2);

        window.print();
    };

    reportButton.addEventListener('click', async () => {
        reportModal.style.display = "block";
        reportContainer.innerHTML = "<p>Carregando dados...</p>";
        
        try {
            const response = await fetch(`${scriptURL}?action=getEmprestimos`);
            const result = await response.json();

            if (result.status === "success") {
                renderReport(result.data);
            } else {
                reportContainer.innerHTML = `<p>${result.message}</p>`;
            }
        } catch (error) {
            console.error('Erro ao buscar o relatório:', error);
            reportContainer.innerHTML = "<p>Erro ao carregar o relatório. Verifique sua conexão ou o Google Apps Script.</p>";
        }
    });

    const renderReport = (emprestimos) => {
        if (emprestimos.length === 0) {
            reportContainer.innerHTML = "<p>Nenhum empréstimo encontrado.</p>";
            return;
        }

        let tableHTML = `
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Instituição</th>
                        <th>Data do Empréstimo</th>
                        <th>Previsão Devolução</th>
                        <th>Itens</th>
                        <th>Status</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
        `;

        emprestimos.forEach(item => {
            const materials = JSON.parse(item.materials).map(m => `${m.quantidade}x ${m.material}`).join(', ');
            const statusClass = item.Status === 'Devolvido' ? 'status-devolvido' : 'status-emprestado';
            const buttonText = item.Status === 'Devolvido' ? 'Devolvido' : 'Marcar como Devolvido';
            const buttonDisabled = item.Status === 'Devolvido' ? 'disabled' : '';
            const dataHora = new Date(item['Data/Hora']);

            tableHTML += `
                <tr>
                    <td>${item['instituicao-recebedora']}</td>
                    <td>${dataHora.toLocaleDateString('pt-BR')}</td>
                    <td>${item['previsao-devolucao'] ? formatDate(item['previsao-devolucao']) : 'N/A'}</td>
                    <td>${materials}</td>
                    <td>${item.Status}</td>
                    <td>
                        <button class="status-button ${statusClass}" data-row="${item.row_index}" ${buttonDisabled}>${buttonText}</button>
                    </td>
                </tr>
            `;
        });
        tableHTML += "</tbody></table>";
        reportContainer.innerHTML = tableHTML;
    };
    
    reportContainer.addEventListener('click', async (e) => {
        if (e.target.classList.contains('status-button')) {
            const button = e.target;
            const rowIndex = button.dataset.row;
            
            if (confirm("Tem certeza que deseja marcar este item como 'Devolvido'?")) {
                button.textContent = "Atualizando...";
                button.disabled = true;

                try {
                    // AQUI está a mudança crucial: usamos o método POST
                    await fetch(scriptURL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            action: 'updateStatus', // Parâmetro para o Apps Script saber o que fazer
                            row_index: rowIndex,
                            status: 'Devolvido'
                        })
                    });
                    
                    button.textContent = "Devolvido";
                    button.classList.remove('status-emprestado');
                    button.classList.add('status-devolvido');
                    alert('Status atualizado com sucesso!');
                    
                } catch (error) {
                    console.error('Erro ao atualizar status:', error);
                    alert('Ocorreu um erro ao atualizar o status.');
                    button.textContent = "Marcar como Devolvido";
                    button.disabled = false;
                }
            }
        }
    });

    closeModalBtn.addEventListener('click', () => {
        reportModal.style.display = "none";
    });

    window.addEventListener('click', (event) => {
        if (event.target == reportModal) {
            reportModal.style.display = "none";
        }
    });
</script>

</body>
</html>
